function dqdt = compute_dynamics(t,q,I, m, Qnc, uav_obj)
%Compute_dynamics Uses the Lagrangian formulation to write the equations of
%motion
%   Detailed explanation goes here

%% Constants
%inertia Tensor
Ixx = I(1,1); 
Iyy = I(2,2);
Izz = I(3,3);
Ixz = I(3,1);
Ixy = I(1,2);
Iyz = I(2,3);

%non conservative forces needed in the inertial frame
%Qnc2 = uav_obj.calculateNCForces;
Fx = Qnc(1);
Fy = Qnc(2);
Fz = Qnc(3);
Mx = Qnc(4);
My = Qnc(5);
Mz = Qnc(6);

%% pull out the state  variables
x = q(1);
y = q(2);
z = q(3);
phi = q(4);
theta = q(5);
psi = q(6);
u = q(7);
v = q(8);
w = q(9);
phi_dot = q(10);
theta_dot = q(11);
psi_dot = q(12);
g = 9.81; %m/s/s
%% equations of motion computed symbolically in syms_lagrange_eqM.m
x_ddot = Fx/m;
y_ddot = Fy/m;
z_ddot = (Fz + g*m)/m;
phi_ddot = (Ixx*Izz*Mx + Ixx*Iyy*Mz*sin(phi) + (Ixx^2*Izz*phi_dot^2*sin(2*phi))/2 + (Ixx^2*Izz*psi_dot^2*sin(2*phi))/2 + (Ixx*Izz^2*theta_dot^2*sin(2*phi))/2 + Ixx*Iyy*Mx*cos(phi)^2 - Ixx*Iyy*Mx*cos(phi)^4 - 2*Ixx*Izz*Mx*cos(phi)^2 + Ixx*Izz*Mx*cos(phi)^4 + Iyy*Izz*Mx*cos(theta)^2 - Ixx*Iyy*Mz*sin(phi)^3 + Ixx*Izz*Mz*sin(phi)^3 - 2*Ixx^2*Izz*phi_dot*psi_dot*cos(phi) + Ixx*Izz^2*psi_dot*theta_dot*cos(theta) + Ixx^2*Iyy*phi_dot^2*cos(phi)^3*sin(phi) - Ixx^2*Izz*phi_dot^2*cos(phi)^3*sin(phi) + Ixx^2*Iyy*psi_dot^2*cos(phi)^3*sin(phi) - Ixx^2*Iyy*psi_dot^2*cos(phi)^5*sin(phi) - 2*Ixx^2*Izz*psi_dot^2*cos(phi)^3*sin(phi) + Ixx^2*Izz*psi_dot^2*cos(phi)^5*sin(phi) - Ixx*Iyy^2*theta_dot^2*cos(phi)^3*sin(phi) + Ixx*Iyy^2*theta_dot^2*cos(phi)^5*sin(phi) - 2*Ixx*Izz^2*theta_dot^2*cos(phi)^3*sin(phi) + Ixx*Izz^2*theta_dot^2*cos(phi)^5*sin(phi) + Ixx*Iyy^2*theta_dot^2*cos(phi)^3*sin(theta) - Ixx*Iyy^2*theta_dot^2*cos(phi)^5*sin(theta) + 2*Ixx*Izz^2*theta_dot^2*cos(phi)^3*sin(theta) - Ixx*Izz^2*theta_dot^2*cos(phi)^5*sin(theta) + Ixx*Iyy*My*cos(phi)^3*cos(theta) - Ixx*Izz*My*cos(phi)^3*cos(theta) - (Ixx*Iyy*Izz*theta_dot^2*sin(2*phi))/2 - 2*Ixx^2*Iyy*phi_dot*psi_dot*cos(phi)^3 + 2*Ixx^2*Iyy*phi_dot*psi_dot*cos(phi)^5 + 4*Ixx^2*Izz*phi_dot*psi_dot*cos(phi)^3 - 2*Ixx^2*Izz*phi_dot*psi_dot*cos(phi)^5 + Iyy*Izz^2*psi_dot*theta_dot*cos(theta)^3 - Iyy^2*Izz*psi_dot*theta_dot*cos(theta)^3 - Ixx*Izz^2*theta_dot^2*cos(phi)*sin(theta) - Ixx*Iyy*My*cos(phi)*cos(theta) + Ixx*Izz*My*cos(phi)*cos(theta) - Ixx*Izz^2*psi_dot^2*cos(phi)*cos(theta)^2*sin(phi) - Iyy*Izz^2*psi_dot^2*cos(phi)*cos(theta)^4*sin(phi) + Iyy^2*Izz*psi_dot^2*cos(phi)*cos(theta)^4*sin(phi) + Iyy*Izz^2*theta_dot^2*cos(phi)*cos(theta)^2*sin(phi) - Iyy^2*Izz*theta_dot^2*cos(phi)*cos(theta)^2*sin(phi) + Ixx*Iyy^2*psi_dot^2*cos(phi)*cos(theta)^2*sin(theta) + 3*Ixx*Iyy*Izz*theta_dot^2*cos(phi)^3*sin(phi) - 2*Ixx*Iyy*Izz*theta_dot^2*cos(phi)^5*sin(phi) - 3*Ixx*Iyy*Izz*theta_dot^2*cos(phi)^3*sin(theta) + 2*Ixx*Iyy*Izz*theta_dot^2*cos(phi)^5*sin(theta) - Ixx*Iyy^2*phi_dot*psi_dot*cos(phi)*cos(theta)^2 + Ixx*Izz^2*phi_dot*psi_dot*cos(phi)*cos(theta)^2 - Ixx*Iyy^2*psi_dot*theta_dot*cos(phi)^2*cos(theta) + 3*Ixx*Iyy^2*psi_dot*theta_dot*cos(phi)^4*cos(theta) - 2*Ixx*Iyy^2*psi_dot*theta_dot*cos(phi)^6*cos(theta) - 4*Ixx*Izz^2*psi_dot*theta_dot*cos(phi)^2*cos(theta) + 5*Ixx*Izz^2*psi_dot*theta_dot*cos(phi)^4*cos(theta) - 2*Ixx*Izz^2*psi_dot*theta_dot*cos(phi)^6*cos(theta) + Ixx*Iyy^2*psi_dot^2*cos(phi)^3*cos(theta)^2*sin(phi) - Ixx*Iyy^2*psi_dot^2*cos(phi)^5*cos(theta)^2*sin(phi) + 2*Ixx*Izz^2*psi_dot^2*cos(phi)^3*cos(theta)^2*sin(phi) - Ixx*Izz^2*psi_dot^2*cos(phi)^5*cos(theta)^2*sin(phi) - 2*Ixx*Iyy^2*psi_dot^2*cos(phi)^3*cos(theta)^2*sin(theta) + Ixx*Iyy^2*psi_dot^2*cos(phi)^5*cos(theta)^2*sin(theta) - Ixx*Izz^2*psi_dot^2*cos(phi)^3*cos(theta)^2*sin(theta) + Ixx*Izz^2*psi_dot^2*cos(phi)^5*cos(theta)^2*sin(theta) + Ixx*Iyy^2*phi_dot*psi_dot*cos(phi)^3*cos(theta)^2 - Ixx*Izz^2*phi_dot*psi_dot*cos(phi)^3*cos(theta)^2 - 2*Iyy*Izz^2*psi_dot*theta_dot*cos(phi)^2*cos(theta)^3 + 2*Iyy^2*Izz*psi_dot*theta_dot*cos(phi)^2*cos(theta)^3 + Ixx*Iyy*Izz*theta_dot^2*cos(phi)*sin(theta) - Ixx*Izz^2*phi_dot*theta_dot*cos(theta)*sin(phi) - Ixx*Iyy*Izz*psi_dot*theta_dot*cos(theta) - Ixx*Iyy^2*phi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(phi) + Ixx*Izz^2*phi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(phi) + 5*Ixx*Iyy*Izz*psi_dot*theta_dot*cos(phi)^2*cos(theta) - 8*Ixx*Iyy*Izz*psi_dot*theta_dot*cos(phi)^4*cos(theta) + 4*Ixx*Iyy*Izz*psi_dot*theta_dot*cos(phi)^6*cos(theta) - 3*Ixx*Iyy*Izz*psi_dot^2*cos(phi)^3*cos(theta)^2*sin(phi) + 2*Ixx*Iyy*Izz*psi_dot^2*cos(phi)^5*cos(theta)^2*sin(phi) + 3*Ixx*Iyy*Izz*psi_dot^2*cos(phi)^3*cos(theta)^2*sin(theta) - 2*Ixx*Iyy*Izz*psi_dot^2*cos(phi)^5*cos(theta)^2*sin(theta) + Ixx*Iyy*Izz*phi_dot*theta_dot*cos(theta)*sin(phi) + 2*Ixx*Iyy*Izz*psi_dot^2*cos(phi)*cos(theta)^2*sin(phi) - Ixx*Iyy*Izz*psi_dot^2*cos(phi)*cos(theta)^2*sin(theta) + 2*Ixx*Iyy^2*psi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(phi)*sin(theta) - 2*Ixx*Iyy^2*psi_dot*theta_dot*cos(phi)^4*cos(theta)*sin(phi)*sin(theta) + 2*Ixx*Izz^2*psi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(phi)*sin(theta) - 2*Ixx*Izz^2*psi_dot*theta_dot*cos(phi)^4*cos(theta)*sin(phi)*sin(theta) + 2*Ixx*Iyy*Izz*psi_dot*theta_dot*cos(theta)*sin(phi)*sin(theta) - 4*Ixx*Iyy*Izz*psi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(phi)*sin(theta) + 4*Ixx*Iyy*Izz*psi_dot*theta_dot*cos(phi)^4*cos(theta)*sin(phi)*sin(theta))/(Ixx*Iyy*Izz*cos(theta)^2);
theta_ddot = (Iyy*Mx*cos(phi)^3 - Izz*Mx*cos(phi)^3 - Iyy*Mx*cos(phi) + Izz*Mx*cos(phi) + Iyy*My*cos(theta) - Iyy*My*cos(phi)^2*cos(theta) + Izz*My*cos(phi)^2*cos(theta) + Iyy^2*phi_dot*psi_dot*cos(theta)^2 - Iyy*Mz*cos(phi)*sin(phi) + Izz*Mz*cos(phi)*sin(phi) + Iyy^2*theta_dot^2*cos(phi)^2*sin(phi) - Iyy^2*theta_dot^2*cos(phi)^4*sin(phi) + Izz^2*theta_dot^2*cos(phi)^2*sin(phi) - Izz^2*theta_dot^2*cos(phi)^4*sin(phi) - Iyy^2*theta_dot^2*cos(phi)^2*sin(theta) + Iyy^2*theta_dot^2*cos(phi)^4*sin(theta) - Izz^2*theta_dot^2*cos(phi)^2*sin(theta) + Izz^2*theta_dot^2*cos(phi)^4*sin(theta) - Iyy^2*psi_dot^2*cos(theta)^2*sin(theta) + 2*Ixx*Iyy*phi_dot*psi_dot*cos(phi)^2 - 2*Ixx*Iyy*phi_dot*psi_dot*cos(phi)^4 - 2*Ixx*Izz*phi_dot*psi_dot*cos(phi)^2 + 2*Ixx*Izz*phi_dot*psi_dot*cos(phi)^4 - Iyy*Izz*phi_dot*psi_dot*cos(theta)^2 - Iyy^2*psi_dot^2*cos(phi)^2*cos(theta)^2*sin(phi) + Iyy^2*psi_dot^2*cos(phi)^4*cos(theta)^2*sin(phi) - Izz^2*psi_dot^2*cos(phi)^2*cos(theta)^2*sin(phi) + Izz^2*psi_dot^2*cos(phi)^4*cos(theta)^2*sin(phi) + 2*Iyy^2*psi_dot^2*cos(phi)^2*cos(theta)^2*sin(theta) - Iyy^2*psi_dot^2*cos(phi)^4*cos(theta)^2*sin(theta) - Izz^2*psi_dot^2*cos(phi)^4*cos(theta)^2*sin(theta) - Iyy^2*phi_dot*psi_dot*cos(phi)^2*cos(theta)^2 + Izz^2*phi_dot*psi_dot*cos(phi)^2*cos(theta)^2 + Iyy^2*psi_dot*theta_dot*cos(phi)*cos(theta) + Izz^2*psi_dot*theta_dot*cos(phi)*cos(theta) - Ixx*Iyy*phi_dot^2*cos(phi)^2*sin(phi) + Ixx*Izz*phi_dot^2*cos(phi)^2*sin(phi) - Ixx*Iyy*psi_dot^2*cos(phi)^2*sin(phi) + Ixx*Iyy*psi_dot^2*cos(phi)^4*sin(phi) + Ixx*Izz*psi_dot^2*cos(phi)^2*sin(phi) - Ixx*Izz*psi_dot^2*cos(phi)^4*sin(phi) - 2*Iyy*Izz*theta_dot^2*cos(phi)^2*sin(phi) + 2*Iyy*Izz*theta_dot^2*cos(phi)^4*sin(phi) + 2*Iyy*Izz*theta_dot^2*cos(phi)^2*sin(theta) - 2*Iyy*Izz*theta_dot^2*cos(phi)^4*sin(theta) - 3*Iyy^2*psi_dot*theta_dot*cos(phi)^3*cos(theta) + 2*Iyy^2*psi_dot*theta_dot*cos(phi)^5*cos(theta) - 3*Izz^2*psi_dot*theta_dot*cos(phi)^3*cos(theta) + 2*Izz^2*psi_dot*theta_dot*cos(phi)^5*cos(theta) + 2*Iyy*Izz*psi_dot^2*cos(phi)^2*cos(theta)^2*sin(phi) - 2*Iyy*Izz*psi_dot^2*cos(phi)^4*cos(theta)^2*sin(phi) - 2*Iyy*Izz*psi_dot^2*cos(phi)^2*cos(theta)^2*sin(theta) + 2*Iyy*Izz*psi_dot^2*cos(phi)^4*cos(theta)^2*sin(theta) + Iyy^2*phi_dot*theta_dot*cos(phi)*cos(theta)*sin(phi) - Izz^2*phi_dot*theta_dot*cos(phi)*cos(theta)*sin(phi) - 2*Iyy*Izz*psi_dot*theta_dot*cos(phi)*cos(theta) + 6*Iyy*Izz*psi_dot*theta_dot*cos(phi)^3*cos(theta) - 4*Iyy*Izz*psi_dot*theta_dot*cos(phi)^5*cos(theta) - 2*Iyy^2*psi_dot*theta_dot*cos(phi)*cos(theta)*sin(phi)*sin(theta) + 2*Iyy^2*psi_dot*theta_dot*cos(phi)^3*cos(theta)*sin(phi)*sin(theta) + 2*Izz^2*psi_dot*theta_dot*cos(phi)^3*cos(theta)*sin(phi)*sin(theta) + 2*Iyy*Izz*psi_dot*theta_dot*cos(phi)*cos(theta)*sin(phi)*sin(theta) - 4*Iyy*Izz*psi_dot*theta_dot*cos(phi)^3*cos(theta)*sin(phi)*sin(theta))/(Iyy*Izz*cos(theta));
psi_ddot = (Izz*Mz - Iyy^2*theta_dot^2*cos(phi)^3 + Iyy^2*theta_dot^2*cos(phi)^5 - 2*Izz^2*theta_dot^2*cos(phi)^3 + Izz^2*theta_dot^2*cos(phi)^5 + Iyy*Mz*cos(phi)^2 - Izz*Mz*cos(phi)^2 - Iyy*Mx*sin(phi)^3 + Izz*Mx*sin(phi)^3 + Izz^2*theta_dot^2*cos(phi) + Iyy*Mx*sin(phi) + Iyy^2*psi_dot^2*cos(phi)^3*cos(theta)^2 - Iyy^2*psi_dot^2*cos(phi)^5*cos(theta)^2 + 2*Izz^2*psi_dot^2*cos(phi)^3*cos(theta)^2 - Izz^2*psi_dot^2*cos(phi)^5*cos(theta)^2 + Ixx*Izz*phi_dot^2*cos(phi) + Ixx*Izz*psi_dot^2*cos(phi) - Iyy*Izz*theta_dot^2*cos(phi) - Izz^2*phi_dot*theta_dot*cos(theta) - Izz^2*psi_dot^2*cos(phi)*cos(theta)^2 + Ixx*Iyy*phi_dot^2*cos(phi)^3 - Ixx*Izz*phi_dot^2*cos(phi)^3 + Ixx*Iyy*psi_dot^2*cos(phi)^3 - Ixx*Iyy*psi_dot^2*cos(phi)^5 - 2*Ixx*Izz*psi_dot^2*cos(phi)^3 + Ixx*Izz*psi_dot^2*cos(phi)^5 + 3*Iyy*Izz*theta_dot^2*cos(phi)^3 - 2*Iyy*Izz*theta_dot^2*cos(phi)^5 - Ixx*Izz*phi_dot*psi_dot*sin(2*phi) + Iyy*Izz*psi_dot*theta_dot*sin(2*theta) - 3*Iyy*Izz*psi_dot^2*cos(phi)^3*cos(theta)^2 + 2*Iyy*Izz*psi_dot^2*cos(phi)^5*cos(theta)^2 - Izz^2*theta_dot^2*cos(phi)*sin(phi)*sin(theta) - Iyy*My*cos(phi)*cos(theta)*sin(phi) + Izz*My*cos(phi)*cos(theta)*sin(phi) + Izz^2*psi_dot*theta_dot*cos(theta)*sin(phi) + Iyy*Izz*phi_dot*theta_dot*cos(theta) + Iyy*Izz*psi_dot^2*cos(phi)*cos(theta)^2 + Iyy^2*theta_dot^2*cos(phi)^3*sin(phi)*sin(theta) + Izz^2*theta_dot^2*cos(phi)^3*sin(phi)*sin(theta) - Iyy^2*phi_dot*theta_dot*cos(phi)^2*cos(theta) + Izz^2*phi_dot*theta_dot*cos(phi)^2*cos(theta) - Iyy^2*psi_dot^2*cos(phi)^3*cos(theta)^2*sin(phi)*sin(theta) - Izz^2*psi_dot^2*cos(phi)^3*cos(theta)^2*sin(phi)*sin(theta) + Iyy*Izz*theta_dot^2*cos(phi)*sin(phi)*sin(theta) - Iyy*Izz*psi_dot*theta_dot*cos(theta)*sin(phi) + Iyy^2*psi_dot^2*cos(phi)*cos(theta)^2*sin(phi)*sin(theta) - 2*Iyy*Izz*theta_dot^2*cos(phi)^3*sin(phi)*sin(theta) - Iyy^2*phi_dot*psi_dot*cos(phi)*cos(theta)^2*sin(phi) + Izz^2*phi_dot*psi_dot*cos(phi)*cos(theta)^2*sin(phi) - Iyy^2*psi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(phi) + 2*Iyy^2*psi_dot*theta_dot*cos(phi)^4*cos(theta)*sin(phi) - 3*Izz^2*psi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(phi) + 2*Izz^2*psi_dot*theta_dot*cos(phi)^4*cos(theta)*sin(phi) + 2*Iyy^2*psi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(theta) - 2*Iyy^2*psi_dot*theta_dot*cos(phi)^4*cos(theta)*sin(theta) + 2*Izz^2*psi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(theta) - 2*Izz^2*psi_dot*theta_dot*cos(phi)^4*cos(theta)*sin(theta) - 2*Ixx*Iyy*phi_dot*psi_dot*cos(phi)^3*sin(phi) + 2*Ixx*Izz*phi_dot*psi_dot*cos(phi)^3*sin(phi) - Iyy*Izz*psi_dot^2*cos(phi)*cos(theta)^2*sin(phi)*sin(theta) + 4*Iyy*Izz*psi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(phi) - 4*Iyy*Izz*psi_dot*theta_dot*cos(phi)^4*cos(theta)*sin(phi) - 4*Iyy*Izz*psi_dot*theta_dot*cos(phi)^2*cos(theta)*sin(theta) + 4*Iyy*Izz*psi_dot*theta_dot*cos(phi)^4*cos(theta)*sin(theta) + 2*Iyy*Izz*psi_dot^2*cos(phi)^3*cos(theta)^2*sin(phi)*sin(theta))/(Iyy*Izz*cos(theta)^2);

dqdt = [u; v; w; phi_dot; theta_dot; psi_dot; x_ddot; y_ddot; z_ddot; phi_ddot; theta_ddot; psi_ddot];

end

